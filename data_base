-- 1. Tạo Database
CREATE DATABASE IF NOT EXISTS web_tro CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE web_tro;

-- 2. Bảng Người dùng (users)
-- Khớp với code: user_data['full_name'], user_data['role']
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE,
    password VARCHAR(255),
    full_name VARCHAR(100),
    email VARCHAR(100),
    phone VARCHAR(20),
    role VARCHAR(20) DEFAULT 'student',
    dob DATE,
    gender VARCHAR(10),
    cccd VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. Bảng Tiện ích (tien_ich)
CREATE TABLE IF NOT EXISTS tien_ich (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ten_tien_ich VARCHAR(50),
    icon VARCHAR(50)
);

-- 4. Bảng Phòng trọ (phong_tro)
-- Khớp với code đăng tin
CREATE TABLE IF NOT EXISTS phong_tro (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ten VARCHAR(255),
    gia DECIMAL(15, 0), -- Dùng số để tính toán cho dễ
    dien_tich INT,
    dia_chi VARCHAR(255),
    anh VARCHAR(255),
    mo_ta TEXT,
    user_id INT,
    is_approved TINYINT(1) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'con_phong',
    loai_phong VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 5. Bảng Ảnh phụ (hinh_anh_phong)
CREATE TABLE IF NOT EXISTS hinh_anh_phong (
    id INT AUTO_INCREMENT PRIMARY KEY,
    phong_id INT,
    ten_anh VARCHAR(255),
    FOREIGN KEY (phong_id) REFERENCES phong_tro(id) ON DELETE CASCADE
);

-- 6. Bảng Trung gian Tiện ích (phong_tien_ich)
CREATE TABLE IF NOT EXISTS phong_tien_ich (
    phong_id INT,
    tien_ich_id INT,
    PRIMARY KEY (phong_id, tien_ich_id),
    FOREIGN KEY (phong_id) REFERENCES phong_tro(id) ON DELETE CASCADE,
    FOREIGN KEY (tien_ich_id) REFERENCES tien_ich(id) ON DELETE CASCADE
);

-- 7. Bảng Yêu thích (yeu_thich)
CREATE TABLE IF NOT EXISTS yeu_thich (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    post_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (post_id) REFERENCES phong_tro(id) ON DELETE CASCADE
);

-- 8. Bảng Bình luận (binh_luan)
CREATE TABLE IF NOT EXISTS binh_luan (
    id INT AUTO_INCREMENT PRIMARY KEY,
    post_id INT,
    user_id INT,
    rating TINYINT DEFAULT 5,
    noi_dung TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES phong_tro(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 9. Bảng Liên hệ (lien_he)
CREATE TABLE IF NOT EXISTS lien_he (
    id INT AUTO_INCREMENT PRIMARY KEY,
    post_id INT,
    user_id INT,
    message TEXT,
    status VARCHAR(20) DEFAULT 'new',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES phong_tro(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 10. Bảng Tin nhắn (tin_nhan)
CREATE TABLE IF NOT EXISTS tin_nhan (
    id INT AUTO_INCREMENT PRIMARY KEY,
    lien_he_id INT,
    sender_id INT,
    message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (lien_he_id) REFERENCES lien_he(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE
);